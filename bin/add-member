#!/usr/bin/env python3
"""
add-member: Add a new team member to the dotML website.

Usage:
    ./bin/add-member --name "Jane Doe" --role "PhD Student" --category phd [--website URL] [--image path]

Options:
    --name NAME         Full name (required)
    --role ROLE         Role/title (required)
    --category CAT      Category: pi, postdoc, phd, masters, undergrad, visiting (required)
    --website URL       Personal website URL
    --image PATH        Path to profile image (relative to static/img/)
    --since YEAR        Year joined (defaults to current year)
    --alumni            Mark as alumni (not current)
"""

import argparse
import sys
from datetime import datetime
from pathlib import Path
import re
import unicodedata

SCRIPT_DIR = Path(__file__).parent
TEAM_DIR = SCRIPT_DIR.parent / "content" / "team"

VALID_CATEGORIES = ['pi', 'postdoc', 'phd', 'masters', 'undergrad', 'visiting']
ROLE_DISPLAY = {
    'pi': 'PI',
    'postdoc': 'Postdoctoral Researcher',
    'phd': 'PhD Student',
    'masters': 'Masters Student',
    'undergrad': 'Undergraduate Student',
    'visiting': 'Visiting Researcher',
}


def slugify(text):
    """Convert text to URL-friendly slug."""
    text = unicodedata.normalize('NFKD', text)
    text = text.encode('ascii', 'ignore').decode('ascii')
    text = re.sub(r'[^\w\s-]', '', text.lower())
    text = re.sub(r'[-\s]+', '-', text).strip('-')
    return text


def create_member(name, role, category, website=None, image=None, since=None, current=True):
    """Create a member markdown file."""
    slug = slugify(name)
    filepath = TEAM_DIR / f"{slug}.md"
    
    if filepath.exists():
        print(f"‚ö†Ô∏è  Member file already exists: {filepath}")
        return filepath
    
    if since is None:
        since = datetime.now().year
    
    # Determine weight (PI first, then by join year)
    weight = 1 if category == 'pi' else 10
    
    content = f'''---
title: "{name}"
role: "{role}"
category: "{category}"
since: {since}
current: {str(current).lower()}
weight: {weight}
'''
    
    if image:
        content += f'image: "/img/{image}"\n'
    else:
        content += 'image: "/img/placeholder-person.svg"\n'
    
    if website:
        content += f'website: "{website}"\n'
    
    content += '''---
'''
    
    filepath.write_text(content)
    print(f"‚úÖ Created member: {filepath}")
    return filepath


def main():
    parser = argparse.ArgumentParser(description="Add a team member to the website")
    parser.add_argument('--name', required=True, help='Full name')
    parser.add_argument('--role', help='Role/title (e.g., "PhD Student", "Postdoc")')
    parser.add_argument('--category', required=True, choices=VALID_CATEGORIES, 
                        help='Member category')
    parser.add_argument('--website', help='Personal website URL')
    parser.add_argument('--image', help='Profile image filename (in static/img/)')
    parser.add_argument('--since', type=int, help='Year joined')
    parser.add_argument('--alumni', action='store_true', help='Mark as alumni')
    
    args = parser.parse_args()
    
    # Use default role if not provided
    role = args.role if args.role else ROLE_DISPLAY.get(args.category, args.category.title())
    
    create_member(
        name=args.name,
        role=role,
        category=args.category,
        website=args.website,
        image=args.image,
        since=args.since,
        current=not args.alumni
    )
    
    if args.image:
        img_path = SCRIPT_DIR.parent / "static" / "img" / args.image
        if not img_path.exists():
            print(f"\n‚ö†Ô∏è  Note: Image file not found at {img_path}")
            print(f"   Please add the image to static/img/{args.image}")
    
    print("\nüéâ Done! Run 'hugo server' to preview changes.")


if __name__ == '__main__':
    main()
